}
se_hat <- numeric(R1)
for (i in 1:R1) {
q_star <- replicate(R2, {
xb <- rnorm(n, mean = mu_hat[i], sd = sd_hat[i])
qnorm(0.999, mean = mean(xb), sd = sd(xb))
})
se_hat[i] <- sd(q_star)
}
summary(se_hat)
se_hat  <- numeric(R1)
ci_low  <- numeric(R1)
ci_high <- numeric(R1)
for (i in 1:R1) {
q_star <- replicate(R2, {
xb <- rnorm(n, mean = mu_hat[i], sd = sd_hat[i])
qnorm(0.999, mean = mean(xb), sd = sd(xb))
})
se_hat[i]  <- sd(q_star)
ci_low[i]  <- q_hat[i] - qnorm(0.975) * se_hat[i]
ci_high[i] <- q_hat[i] + qnorm(0.975) * se_hat[i]
}
# (e) standard deviation of each set (=> 999 SE estimates)
se_hat <- apply(Qstar, 2, sd)   # length 999
# (e) standard deviation of each set (=> 999 SE estimates)
se_hat <- apply(q_star, 2, sd)   # length 999
se_hat  <- numeric(R1)
ci_low  <- numeric(R1)
ci_high <- numeric(R1)
Qstar <- matrix(NA, nrow = R2, ncol = R1)  # each column = one set (size 999)
for (i in 1:R1) {
Qstar[, i] <- replicate(R2, {
xb <- rnorm(n, mean = mu_hat[i], sd = sd_hat[i])
qnorm(0.999, mean = mean(xb), sd = sd(xb))
})
}
se_hat <- apply(Qstar, 2, sd)
length(se_hat)
summary(se_hat)
# (a) Set true parameters to sample mean/sd from escape data
mu    <- mean(escape)
sigma <- sd(escape)
n     <- length(escape)
# True 99.9th percentile
q_true <- qnorm(0.999, mean = mu, sd = sigma)
R1 <- 999
mu_hat <- numeric(R1)
sd_hat <- numeric(R1)
q_hat  <- numeric(R1)
## calulate the mean and se right away
for (i in 1:R1) {
x <- rnorm(n, mean = mu, sd = sigma)
mu_hat[i] <- mean(x)
sd_hat[i] <- sd(x)
q_hat[i]  <- qnorm(0.999, mean = mu_hat[i], sd = sd_hat[i])
}
R2 <-900
q_star_mat <- matrix(NA_real_, nrow = R1, ncol = R2)
for (i in 1:R1) {
q_star_mat[i, ] <- replicate(R2, {
xb <- rnorm(n, mean = mu_hat[i], sd = sd_hat[i])
qnorm(0.999, mean = mean(xb), sd = sd(xb))
})
}
# (a) Set true parameters to sample mean/sd from escape data
mu    <- mean(escape)
sigma <- sd(escape)
n     <- length(escape)
# True 99.9th percentile
q_true <- qnorm(0.999, mean = mu, sd = sigma)
R1 <- 999
mu_hat <- numeric(R1)
sd_hat <- numeric(R1)
q_hat  <- numeric(R1)
## calulate the mean and se right away
for (i in 1:R1) {
x <- rnorm(n, mean = mu, sd = sigma)
mu_hat[i] <- mean(x)
sd_hat[i] <- sd(x)
q_hat[i]  <- qnorm(0.999, mean = mu_hat[i], sd = sd_hat[i])
}
R2 <-900
q_star_mat <- matrix(NA_real_, nrow = R1, ncol = R2)
for (i in 1:R1) {
q_star_mat[i, ] <- replicate(R2, {
xb <- rnorm(n, mean = mu_hat[i], sd = sd_hat[i])
qnorm(0.999, mean = mean(xb), sd = sd(xb))
})
}
se_hat <- apply(q_star_mat, 1, sd)
length(se_hat)
summary(se_hat)
z <- qnorm(0.975)
ci_low  <- q_hat - z * se_hat
ci_high <- q_hat + z * se_hat
length(ci_low)
length(ci_high)
CI_df <- data.frame(ci_low = ci_low, ci_high = ci_high)
head(CI_df)
q_true <- qnorm(0.999, mean = mu, sd = sigma)
count_contain <- sum(ci_low <= q_true & q_true <= ci_high)
pct_correct <- 100 * mean(ci_low <= q_true & q_true <= ci_high)
count_contain
pct_correct
q_true <- qnorm(0.999, mean = mu, sd = sigma)
count_contain <- sum(ci_low <= q_true & q_true <= ci_high)
pct_correct <- 100 * mean(ci_low <= q_true & q_true <= ci_high)
count_contain
pct_correct
q_true <- qnorm(0.999, mean = mu, sd = sigma)
count_contain <- sum(ci_low <= q_true & q_true <= ci_high)
pct_correct <- 100 * mean(ci_low <= q_true & q_true <= ci_high)
count_contain
pct_correct
log_liklihood = function(beta, x){
n = length(x)
sum(log(x)) - 2*n*log(beta) - sum(x)/beta
}
### optimized beta:
final_beta = function(x){
mean = mean(x)
mean/2
}
x = c(9,5,7)
beta_hat_1 = optimize(lfx, interval = c(1e-6, 20), x = x, maximum = TRUE)$maximum
x = c(9,5,7)
beta_hat_1 = optimize(log_liklihood, interval = c(1e-6, 20), x = x, maximum = TRUE)$maximum
beta_hat_1
beta_hat_2 = fina_beta(x)
x = c(9,5,7)
beta_hat_1 = optimize(log_liklihood, interval = c(1e-6, 20), x = x, maximum = TRUE)$maximum
beta_hat_1
beta_hat_2 = final_beta(x)
beta_hat_2
x <- c(9, 5, 7)
n <- length(x)
beta_hat <- final_beta(x)
B <- 999
beta_star <- replicate(B, {
xb <- rgamma(n, shape = alpha, scale = beta_hat)
final_beta(xb)
})
x <- c(9, 5, 7)
n <- length(x)
beta_hat <- final_beta(x)
B <- 999
beta_star <- replicate(B, {
xb <- rgamma(n, shape = 2, scale = beta_hat)
final_beta(xb)
})
se_boot <- sd(beta_star)
beta_hat
se_boot
x <- c(9, 5, 7)
n <- length(x)
beta_hat <- final_beta(x)
B <- 999
beta_star <- replicate(B, {
xb <- rgamma(n, shape = 2, scale = beta_hat)
final_beta(xb)
})
se_boot <- sd(beta_star)
se_boot
x = c(9,5,7)
### i wanted to try it with the optimize function
beta_hat_1 = optimize(log_liklihood, interval = c(1e-6, 20), x = x, maximum = TRUE)$maximum
beta_hat_1
## this is using the knowledge that the minimizing the log liklihood using derivaties is beta_hat = mean/2
beta_hat_2 = final_beta(x)
beta_hat_2
log_liklihood = function(beta, x){
n = length(x)
sum(log(x)) - 2*n*log(beta) - sum(x)/beta
}
x = c(9,5,7)
### i wanted to try it with the optimize function
beta_hat_1 = optimize(log_liklihood, interval = c(1e-6, 20), x = x, maximum = TRUE)$maximum
beta_hat_1
x <- c(9, 5, 7)
n <- length(x)
beta_hat <- final_beta(x)
B <- 999
beta_star <- replicate(B, {
xb <- rgamma(n, shape = 2, scale = beta_hat)
final_beta(xb)
})
se_boot <- sd(beta_star)
se_boot
x <- c(9, 5, 7)
n <- length(x)
beta_hat = optimize(log_liklihood, interval = c(1e-6, 20), x = x, maximum = TRUE)$maximum
beta_hat
B <- 999
beta_star <- replicate(B, {
xb <- rgamma(n, shape = 2, scale = beta_hat)
beta_hat = optimize(log_liklihood, interval = c(1e-6, 20), x = xb, maximum = TRUE)$maximum
})
se_boot <- sd(beta_star)
se_boot
x <- c(9, 5, 7)
n <- length(x)
beta_hat = optimize(log_liklihood, interval = c(1e-6, 20), x = x, maximum = TRUE)$maximum
B <- 999
beta_star <- replicate(B, {
xb <- rgamma(n, shape = 2, scale = beta_hat)
beta_hat = optimize(log_liklihood, interval = c(1e-6, 20), x = xb, maximum = TRUE)$maximum
})
se_boot <- sd(beta_star)
se_boot
library(tibble)
library(purrr)
library(dplyr)
#' Build module-level tables (one tibble per module) from CT.gov v2 JSON
#'
#' @param studies List of study records (e.g., result$studies).
#' @param modules Character vector of protocolSection module names to include.
#'   Use "all" to include all supported modules.
#' @return Named list of tibbles. Each tibble has 1 row per study.
studies_to_tables_by_module <- function(
studies,
modules = c("identificationModule", "statusModule", "sponsorCollaboratorsModule", "designModule")
) {
extractors <- list(
identificationModule = function(st) tibble(
nct_id        = get_in(st, c("protocolSection","identificationModule","nctId")),
org_study_id   = get_in(st, c("protocolSection","identificationModule","orgStudyIdInfo","id")),
brief_title    = get_in(st, c("protocolSection","identificationModule","briefTitle")),
official_title = get_in(st, c("protocolSection","identificationModule","officialTitle")),
acronym        = get_in(st, c("protocolSection","identificationModule","acronym"))
),
statusModule = function(st) tibble(
nct_id                   = get_in(st, c("protocolSection","identificationModule","nctId")),
overall_status           = get_in(st, c("protocolSection","statusModule","overallStatus")),
status_verified_ym       = get_in(st, c("protocolSection","statusModule","statusVerifiedDate")),
start_date               = get_in(st, c("protocolSection","statusModule","startDateStruct","date")),
start_date_type          = get_in(st, c("protocolSection","statusModule","startDateStruct","type")),
primary_completion_date  = get_in(st, c("protocolSection","statusModule","primaryCompletionDateStruct","date")),
primary_completion_type  = get_in(st, c("protocolSection","statusModule","primaryCompletionDateStruct","type")),
completion_date          = get_in(st, c("protocolSection","statusModule","completionDateStruct","date")),
completion_date_type     = get_in(st, c("protocolSection","statusModule","completionDateStruct","type")),
last_update_posted       = get_in(st, c("protocolSection","statusModule","lastUpdatePostDateStruct","date")),
last_update_posted_type  = get_in(st, c("protocolSection","statusModule","lastUpdatePostDateStruct","type")),
why_stopped              = get_in(st, c("protocolSection","statusModule","whyStopped"))
),
sponsorCollaboratorsModule = function(st) {
collabs <- st$protocolSection$sponsorCollaboratorsModule$collaborators %||% list()
collab_names <- unique(vapply(collabs, function(z) z$name %||% NA_character_, character(1)))
collab_names <- collab_names[!is.na(collab_names)]
tibble(
nct_id             = get_in(st, c("protocolSection","identificationModule","nctId")),
lead_sponsor_name  = get_in(st, c("protocolSection","sponsorCollaboratorsModule","leadSponsor","name")),
lead_sponsor_class = get_in(st, c("protocolSection","sponsorCollaboratorsModule","leadSponsor","class")),
collaborators      = if (length(collab_names) == 0) NA_character_ else paste(collab_names, collapse = "; ")
)
},
designModule = function(st) {
phases <- st$protocolSection$designModule$phases %||% character(0)
tibble(
nct_id             = get_in(st, c("protocolSection","identificationModule","nctId")),
study_type         = get_in(st, c("protocolSection","designModule","studyType")),
phases             = if (length(phases) == 0) NA_character_ else paste(unlist(phases), collapse = ", "),
allocation         = get_in(st, c("protocolSection","designModule","designInfo","allocation")),
intervention_model = get_in(st, c("protocolSection","designModule","designInfo","interventionModel")),
primary_purpose    = get_in(st, c("protocolSection","designModule","designInfo","primaryPurpose")),
masking            = get_in(st, c("protocolSection","designModule","designInfo","maskingInfo","masking")),
enrollment_count   = get_in(st, c("protocolSection","designModule","enrollmentInfo","count")),
enrollment_type    = get_in(st, c("protocolSection","designModule","enrollmentInfo","type"))
)
},
eligibilityModule = function(st) tibble(
nct_id                = get_in(st, c("protocolSection","identificationModule","nctId")),
eligibility_criteria  = get_in(st, c("protocolSection","eligibilityModule","eligibilityCriteria")),
healthy_volunteers    = get_in(st, c("protocolSection","eligibilityModule","healthyVolunteers")),
sex                   = get_in(st, c("protocolSection","eligibilityModule","sex")),
minimum_age           = get_in(st, c("protocolSection","eligibilityModule","minimumAge")),
maximum_age           = get_in(st, c("protocolSection","eligibilityModule","maximumAge")),
std_ages              = {
ages <- st$protocolSection$eligibilityModule$stdAges %||% character(0)
if (length(ages) == 0) NA_character_ else paste(unlist(ages), collapse = ", ")
}
),
contactsLocationsModule = function(st) {
locs <- st$protocolSection$contactsLocationsModule$locations %||% list()
countries <- unique(vapply(locs, function(z) z$country %||% NA_character_, character(1)))
countries <- countries[!is.na(countries)]
cities <- unique(vapply(locs, function(z) z$city %||% NA_character_, character(1)))
cities <- cities[!is.na(cities)]
tibble(
nct_id     = get_in(st, c("protocolSection","identificationModule","nctId")),
n_sites    = length(locs),
countries  = if (length(countries) == 0) NA_character_ else paste(countries, collapse = "; "),
cities     = if (length(cities) == 0) NA_character_ else paste(cities, collapse = "; ")
)
},
referencesModule = function(st) {
refs <- st$protocolSection$referencesModule$references %||% list()
pmids <- vapply(refs, function(r) r$pmid %||% NA_character_, character(1))
pmids <- pmids[!is.na(pmids) & nzchar(pmids)]
citations <- vapply(refs, function(r) r$citation %||% NA_character_, character(1))
citations <- citations[!is.na(citations) & nzchar(citations)]
tibble(
nct_id        = get_in(st, c("protocolSection","identificationModule","nctId")),
n_references  = length(refs),
pmids         = if (length(pmids) == 0) NA_character_ else paste(unique(pmids), collapse = "; "),
citations     = if (length(citations) == 0) NA_character_ else paste(unique(citations), collapse = " | ")
)
}
)
supported <- names(extractors)
if (length(modules) == 1 && identical(modules, "all")) {
modules <- supported
}
bad <- setdiff(modules, supported)
if (length(bad) > 0) {
stop(
"Unknown module(s): ", paste(bad, collapse = ", "),
"\nSupported modules: ", paste(supported, collapse = ", ")
)
}
# build one tibble per module (named list)
tables <- set_names(modules) |>
map(function(m) {
tab <- map_dfr(studies, extractors[[m]])
# de-dup by nct_id when present
if ("nct_id" %in% names(tab)) {
tab <- distinct(tab, nct_id, .keep_all = TRUE)
}
tab
})
tables
}
tabs <- studies_to_tables_by_module(result$studies, modules = c("identificationModule","designModule"))
tabs <- studies_to_tables_by_module(result$studies, modules = c("identificationModule","designModule"))
tabs <- studies_to_tables_by_module(result$studies, modules = c("identificationModule"))
tabs <- studies_to_tables_by_module(my_response$studies, modules = "all")
tabs <- studies_to_tables_by_module(res$studies, modules = "all")
options(error = NULL)
ls()
tabs <- studies_to_tables_by_module(res$studies, modules = "all")
library(tibble)
library(purrr)
library(dplyr)
#' Build module-level tables (one tibble per module) from CT.gov v2 JSON
#'
#' @param studies List of study records (e.g., result$studies).
#' @param modules Character vector of protocolSection module names to include.
#'   Use "all" to include all supported modules.
#' @return Named list of tibbles. Each tibble has 1 row per study.
studies_to_tables_by_module <- function(
studies,
modules = c("identificationModule", "statusModule", "sponsorCollaboratorsModule", "designModule")
) {
extractors <- list(
identificationModule = function(st) tibble(
nct_id        = get_in(st, c("protocolSection","identificationModule","nctId")),
org_study_id   = get_in(st, c("protocolSection","identificationModule","orgStudyIdInfo","id")),
brief_title    = get_in(st, c("protocolSection","identificationModule","briefTitle")),
official_title = get_in(st, c("protocolSection","identificationModule","officialTitle")),
acronym        = get_in(st, c("protocolSection","identificationModule","acronym"))
),
statusModule = function(st) tibble(
nct_id                   = get_in(st, c("protocolSection","identificationModule","nctId")),
overall_status           = get_in(st, c("protocolSection","statusModule","overallStatus")),
status_verified_ym       = get_in(st, c("protocolSection","statusModule","statusVerifiedDate")),
start_date               = get_in(st, c("protocolSection","statusModule","startDateStruct","date")),
start_date_type          = get_in(st, c("protocolSection","statusModule","startDateStruct","type")),
primary_completion_date  = get_in(st, c("protocolSection","statusModule","primaryCompletionDateStruct","date")),
primary_completion_type  = get_in(st, c("protocolSection","statusModule","primaryCompletionDateStruct","type")),
completion_date          = get_in(st, c("protocolSection","statusModule","completionDateStruct","date")),
completion_date_type     = get_in(st, c("protocolSection","statusModule","completionDateStruct","type")),
last_update_posted       = get_in(st, c("protocolSection","statusModule","lastUpdatePostDateStruct","date")),
last_update_posted_type  = get_in(st, c("protocolSection","statusModule","lastUpdatePostDateStruct","type")),
why_stopped              = get_in(st, c("protocolSection","statusModule","whyStopped"))
),
sponsorCollaboratorsModule = function(st) {
collabs <- st$protocolSection$sponsorCollaboratorsModule$collaborators %||% list()
collab_names <- unique(vapply(collabs, function(z) z$name %||% NA_character_, character(1)))
collab_names <- collab_names[!is.na(collab_names)]
tibble(
nct_id             = get_in(st, c("protocolSection","identificationModule","nctId")),
lead_sponsor_name  = get_in(st, c("protocolSection","sponsorCollaboratorsModule","leadSponsor","name")),
lead_sponsor_class = get_in(st, c("protocolSection","sponsorCollaboratorsModule","leadSponsor","class")),
collaborators      = if (length(collab_names) == 0) NA_character_ else paste(collab_names, collapse = "; ")
)
},
designModule = function(st) {
phases <- st$protocolSection$designModule$phases %||% character(0)
tibble(
nct_id             = get_in(st, c("protocolSection","identificationModule","nctId")),
study_type         = get_in(st, c("protocolSection","designModule","studyType")),
phases             = if (length(phases) == 0) NA_character_ else paste(unlist(phases), collapse = ", "),
allocation         = get_in(st, c("protocolSection","designModule","designInfo","allocation")),
intervention_model = get_in(st, c("protocolSection","designModule","designInfo","interventionModel")),
primary_purpose    = get_in(st, c("protocolSection","designModule","designInfo","primaryPurpose")),
masking            = get_in(st, c("protocolSection","designModule","designInfo","maskingInfo","masking")),
enrollment_count   = get_in(st, c("protocolSection","designModule","enrollmentInfo","count")),
enrollment_type    = get_in(st, c("protocolSection","designModule","enrollmentInfo","type"))
)
},
eligibilityModule = function(st) tibble(
nct_id                = get_in(st, c("protocolSection","identificationModule","nctId")),
eligibility_criteria  = get_in(st, c("protocolSection","eligibilityModule","eligibilityCriteria")),
healthy_volunteers    = get_in(st, c("protocolSection","eligibilityModule","healthyVolunteers")),
sex                   = get_in(st, c("protocolSection","eligibilityModule","sex")),
minimum_age           = get_in(st, c("protocolSection","eligibilityModule","minimumAge")),
maximum_age           = get_in(st, c("protocolSection","eligibilityModule","maximumAge")),
std_ages              = {
ages <- st$protocolSection$eligibilityModule$stdAges %||% character(0)
if (length(ages) == 0) NA_character_ else paste(unlist(ages), collapse = ", ")
}
),
contactsLocationsModule = function(st) {
locs <- st$protocolSection$contactsLocationsModule$locations %||% list()
countries <- unique(vapply(locs, function(z) z$country %||% NA_character_, character(1)))
countries <- countries[!is.na(countries)]
cities <- unique(vapply(locs, function(z) z$city %||% NA_character_, character(1)))
cities <- cities[!is.na(cities)]
tibble(
nct_id     = get_in(st, c("protocolSection","identificationModule","nctId")),
n_sites    = length(locs),
countries  = if (length(countries) == 0) NA_character_ else paste(countries, collapse = "; "),
cities     = if (length(cities) == 0) NA_character_ else paste(cities, collapse = "; ")
)
},
referencesModule = function(st) {
refs <- st$protocolSection$referencesModule$references %||% list()
pmids <- vapply(refs, function(r) r$pmid %||% NA_character_, character(1))
pmids <- pmids[!is.na(pmids) & nzchar(pmids)]
citations <- vapply(refs, function(r) r$citation %||% NA_character_, character(1))
citations <- citations[!is.na(citations) & nzchar(citations)]
tibble(
nct_id        = get_in(st, c("protocolSection","identificationModule","nctId")),
n_references  = length(refs),
pmids         = if (length(pmids) == 0) NA_character_ else paste(unique(pmids), collapse = "; "),
citations     = if (length(citations) == 0) NA_character_ else paste(unique(citations), collapse = " | ")
)
}
)
supported <- names(extractors)
if (length(modules) == 1 && identical(modules, "all")) {
modules <- supported
}
bad <- setdiff(modules, supported)
if (length(bad) > 0) {
stop(
"Unknown module(s): ", paste(bad, collapse = ", "),
"\nSupported modules: ", paste(supported, collapse = ", ")
)
}
# build one tibble per module (named list)
tables <- set_names(modules) |>
map(function(m) {
tab <- map_dfr(studies, extractors[[m]])
# de-dup by nct_id when present
if ("nct_id" %in% names(tab)) {
tab <- distinct(tab, nct_id, .keep_all = TRUE)
}
tab
})
tables
}
# helpers.R (same as yours)
`%||%` <- function(a, b) {
if (is.null(a) || length(a) == 0) b else a
}
get_in <- function(x, path, default = NA_character_) {
for (nm in path) {
if (is.null(x[[nm]])) return(default)
x <- x[[nm]]
}
if (is.null(x) || length(x) == 0) return(default)
if (is.atomic(x)) return(as.character(x)[1])
default
}
tabs <- studies_to_tables_by_module(result$studies, modules = c("identificationModule","designModule"))
spec <- list(
query = "cancer",
max_records = 10,
phase = "Phase 2",
country = "Canada",
from_date = "2022-01-01",
to_date = "2023-01-01",
date_filter = "StartDate"
)
result <- trials_run_spec(spec)
devtools::load_all()
devtools::document()
getwd()
getwd()
setwd("C:/Users/preet/Documents/DATA532/clinicalTrailsR")
setwd("C:/Users/preet/Documents/DATA534/clinicalTrailsR")
setwd("C:/Users/preet/Documents/DATA534/clinicaltrialsR")
devtools::document()
devtools::document()
read.dcf("DESCRIPTION")
read.dcf("DESCRIPTION")
devtools::document()
install.packages("roxygen2")
install.packages("devtools")  # optional but recommended
devtools::document()
devtools::check()
devtools::document()
devtools::check()
devtools::document()
devtools::check()
devtools::load_all()
library(tidytrials)
res <- search_studies("diabetes")
library(tidytrials)
res <- trials_fetch("diabetes")
res[0]
res
